{% extends "opendims/base_map.html" %}

{% load staticfiles %}

{% block title %}{{ block.super }} - Event Map{% endblock %}

{% block map_navbar_tools %}
<li class="hidden"><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="full-extent-btn"><i class="fa fa-arrows-alt"></i>&nbsp;&nbsp;Zoom To Full Extent</a></li>
<li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="filter-btn"><i class="fa fa-filter"></i>&nbsp;&nbsp;Filter</a></li>
{% endblock %}

{% block map_navbar %}
<li class="dropdown">
  <a id="downloadDrop" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-cloud-download white"></i>&nbsp;&nbsp;Download GeoJSON <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="{% url 'reports:event_api' %}?disaster=ABR&format=json" download="ABR.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Abrasi</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=CEK&format=json" download="CEK.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Angin Kencang</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=BJR&format=json" download="BJR.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Banjir</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=ROB&format=json" download="ROB.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Banjir Rob</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=GMP&format=json" download="GMP.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Gempa Bumi</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=KBK&format=json" download="KBK.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Kebakaran</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=SOS&format=json" download="SOS.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Konflik Sosial</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=LAI&format=json" download="LAI.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Lain-lain</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=LSR&format=json" download="LSR.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Longsor</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=TER&format=json" download="TER.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Terorisme</a></li>
    <li><a href="{% url 'reports:event_api' %}?disaster=TSU&format=json" download="TSU.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in"><i class="fa fa-download"></i>&nbsp;&nbsp;Tsunami</a></li>
  </ul>
</li>
{% endblock %}

{% block map_sidebar_title %}Events{% endblock %}

{% block modal_about_title %}Event Map{% endblock %}

{% block modal_about_description %}
<p>Map description.</p>
{% endblock %}

{% block modal_about_disclaimer %}
<p>The data provided on this site is for informational purposes only.</p>
<p>Absolutely no accuracy or completeness guarantee is implied or intended.</p>
{% endblock %}

{% block modal_about_contact %}
<p>Contact information.</p>
{% endblock %}

{% block modal_legend %}
<p>Map legend.</p>
{% endblock %}

{% block map_modal %}
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Filter</h4>
      </div>
      <div class="modal-body">
        <form id="filter-form">
          <fieldset>
            <div class="form-group">
              <label for="name">Username:</label>
              <input type="text" class="form-control" id="username">
            </div>
            <div class="form-group">
              <label for="email">Password:</label>
              <input type="password" class="form-control" id="password">
            </div>
          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" data-dismiss="modal">Filter</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
{% endblock %}

{% block extra_js %}
var ABRSearch = [], CEKSearch = [], BJRSearch = [], ROBSearch = [], GMPSearch = [], KBKSearch = [], SOSSearch = [], LAISearch = [], LSRSearch = [], TERSearch = [], TSUSearch = [];

$("#full-extent-btn").click(function() {
  //map.fitBounds(BJR.getBounds());
  $(".navbar-collapse.in").collapse("hide");
  return false;
});

$("#filter-btn").click(function() {
  $("#filterModal").modal("show");
  $(".navbar-collapse.in").collapse("hide");
  return false;
});

function syncSidebarLayer(layer, layerGroup, markerImgPath) {
  if (map.hasLayer(layerGroup)) {
    var center;

    // Event geometry can be Point or MultiPolygon
    if (layer.feature.geometry.type === 'Point') {
      center = layer.getLatLng();
    }
    else if (layer.feature.geometry.type === 'MultiPolygon') {
      var bounds = layer.getBounds();
      center = bounds.getCenter();
    }

    if (map.getBounds().contains(center)) {
      if (layer.feature.properties) {
        var featureCreated = " - ";
        var featureDisaster = " - ";
        var featureProvinceName = " - ";
        var featureCityName = " - ";
        var featureSubdistrictName = " - ";
        var featureVillageName = " - ";
        var featureRWName = " - ";
        var featureRTName = " - ";

        if (layer.feature.properties.created) {
          featureCreated = layer.feature.properties.created;
        }
        if (layer.feature.properties.disaster) {
          featureDisaster = layer.feature.properties.disaster;
        }
        if (layer.feature.properties.province) {
          featureProvinceName = layer.feature.properties.province_name;
        }
        if (layer.feature.properties.city) {
          featureCityName = layer.feature.properties.city_name;
        }
        if (layer.feature.properties.subdistrict) {
          featureSubdistrictName = layer.feature.properties.subdistrict_name;
        }
        if (layer.feature.properties.village) {
          featureVillageName = layer.feature.properties.village_name;
        }
        if (layer.feature.properties.rw) {
          featureRWName = layer.feature.properties.rw_name;
        }
        if (layer.feature.properties.rt) {
          featureRTName = layer.feature.properties.rt_name;
        }

        var featureName = featureDisaster + ' - ' + featureCreated;
        var featureLocation = featureProvinceName + ', ' + featureCityName + ', ' + featureSubdistrictName + ', ' + featureVillageName + ', ' + featureRWName + ', ' + featureRTName;

        $("#feature-list tbody").append('<tr class="feature-row" id="' + L.stamp(layer) + '" lat="' + center.lat + '" lng="' + center.lng + '"><td style="vertical-align: middle;"><img width="16" height="18" src="' + markerImgPath + '"></td><td class="feature-name">' + featureName + '<br><small>' + featureLocation + '</small></td><td style="vertical-align: middle;"><i class="fa fa-chevron-right pull-right"></i></td></tr>');
      }
      // end if (layer.feature.properties)
    }
  }
}
// end syncSidebarLayer()

function syncSidebar() {
  /* Empty sidebar features */
  $("#feature-list tbody").empty();

  ABR.eachLayer(function (layer) {
    syncSidebarLayer(layer, ABRLayer, "{% static 'img/markers/abration.png' %}");
  });

  CEK.eachLayer(function (layer) {
    syncSidebarLayer(layer, CEKLayer, "{% static 'img/markers/tornado.png' %}");
  });

  BJR.eachLayer(function (layer) {
    syncSidebarLayer(layer, BJRLayer, "{% static 'img/markers/flood.png' %}");
  });

  ROB.eachLayer(function (layer) {
    syncSidebarLayer(layer, ROBLayer, "{% static 'img/markers/seaflood.png' %}");
  });

  GMP.eachLayer(function (layer) {
    syncSidebarLayer(layer, GMPLayer, "{% static 'img/markers/earthquake.png' %}");
  });

  KBK.eachLayer(function (layer) {
    syncSidebarLayer(layer, KBKLayer, "{% static 'img/markers/fire.png' %}");
  });

  SOS.eachLayer(function (layer) {
    syncSidebarLayer(layer, SOSLayer, "{% static 'img/markers/strike.png' %}");
  });

  LAI.eachLayer(function (layer) {
    syncSidebarLayer(layer, LAILayer, "{% static 'img/markers/caution.png' %}");
  });

  LSR.eachLayer(function (layer) {
    syncSidebarLayer(layer, LSRLayer, "{% static 'img/markers/avalanche.png' %}");
  });

  TER.eachLayer(function (layer) {
    syncSidebarLayer(layer, TERLayer, "{% static 'img/markers/shooting.png' %}");
  });

  TSU.eachLayer(function (layer) {
    syncSidebarLayer(layer, TSULayer, "{% static 'img/markers/tsunami.png' %}");
  });
}
// end syncSidebar()

function drawLayerFeature(feature, layer, markerImgPath, layerGroupSearch, layerGroupSearchSource) {
  var center;

  // Event geometry can be either a MultiPolygon or Point
  if (feature.geometry.type === 'MultiPolygon') {
    // Get bounds and center of polygon
    var bounds = layer.getBounds();
    center = bounds.getCenter();
  }
  else if (feature.geometry.type === 'Point') {
    center = layer.getLatLng();
  }

  if (feature.properties) {
    var featureCreated = " - ";
    var featureDisaster = " - ";
    var featureProvinceName = " - ";
    var featureCityName = " - ";
    var featureSubdistrictName = " - ";
    var featureVillageName = " - ";
    var featureRWName = " - ";
    var featureRTName = " - ";
    var contentCreated = " - ";
    var contentDisaster = " - ";
    var contentProvince = " - ";
    var contentCity = " - ";
    var contentSubdistrict = " - ";
    var contentVillage = " - ";
    var contentRW = " - ";
    var contentRT = " - ";
    var contentDetail = " - ";
    var contentReports = " - ";

    if (feature.properties.created) {
      featureCreated = feature.properties.created;
      contentCreated = featureCreated;
    }
    if (feature.properties.disaster) {
      featureDisaster = feature.properties.disaster;
    }
    if (feature.properties.disaster_note) {
      contentDisaster = feature.properties.disaster_note;
    }
    if (feature.properties.province) {
      featureProvinceName = feature.properties.province_name;
      contentProvince = "<a class='url-break' href='" + "{% url "geolevels:province_list" %}" + feature.properties.province + "' target='_blank'>" + feature.properties.province_name  + "</a>";
    }
    if (feature.properties.city) {
      featureCityName = feature.properties.city_name;
      contentCity = "<a class='url-break' href='" + "{% url "geolevels:city_list" %}" + feature.properties.city + "' target='_blank'>" + feature.properties.city_name  + "</a>";
    }
    if (feature.properties.subdistrict) {
      featureSubdistrictName = feature.properties.subdistrict_name;
      contentSubdistrict = "<a class='url-break' href='" + "{% url "geolevels:subdistrict_list" %}" + feature.properties.subdistrict + "' target='_blank'>" + feature.properties.subdistrict_name  + "</a>";
    }
    if (feature.properties.village) {
      featureVillageName = feature.properties.village_name;
      contentVillage = "<a class='url-break' href='" + "{% url "geolevels:village_list" %}" + feature.properties.village + "' target='_blank'>" + feature.properties.village_name  + "</a>";
    }
    if (feature.properties.rw) {
      featureRWName = feature.properties.rw_name;
      contentRW = "<a class='url-break' href='" + "{% url "geolevels:rw_list" %}" + feature.properties.rw + "' target='_blank'>" + feature.properties.rw_name  + "</a>";
    }
    if (feature.properties.rt) {
      featureRTName = feature.properties.rt_name;
      contentRT = "<a class='url-break' href='" + "{% url "geolevels:rt_list" %}" + feature.properties.rt + "' target='_blank'>" + feature.properties.rt_name  + "</a>";
    }
    if (feature.id) {
      contentDetail = "<a class='url-break' href='" + "{% url "reports:event_list" %}" + feature.id + "' target='_blank'>" + "View event detail"  + "</a>";
    }
    if (feature.properties.reports) {
      if (feature.properties.reports.length > 0) {
        contentReports = "<ol style='margin-bottom: 0;'>";
        for (var i = 0; i < feature.properties.reports.length; i++) {
          contentReports = contentReports + "<li><a class='url-break' href='" + "{% url "reports:report_list" %}" + feature.properties.reports[i].id + "' target='_blank'>" + feature.properties.reports[i].source_note  + "</a></li>";
        }
        contentReports = contentReports + "</ol>";
      }
    }

    var featureName = featureDisaster + ' - ' + featureCreated;
    var featureLocation = featureProvinceName + ', ' + featureCityName + ', ' + featureSubdistrictName + ', ' + featureVillageName + ', ' + featureRWName + ', ' + featureRTName;
    var popupContent = featureName + ': ' + featureLocation;

    var content = "<table class='table table-striped table-bordered table-condensed'>";
    content = content + "<tr><th>Created</th><td>" + contentCreated + "</td></tr>";
    content = content + "<tr><th>Disaster</th><td>" + contentDisaster + "</td></tr>";
    content = content + "<tr><th>Province</th><td>" + contentProvince  + "</td></tr>";
    content = content + "<tr><th>City</th><td>" + contentCity  + "</td></tr>";
    content = content + "<tr><th>Subdistrict</th><td>" + contentSubdistrict  + "</td></tr>";
    content = content + "<tr><th>Village</th><td>" + contentVillage  + "</td></tr>";
    content = content + "<tr><th>RW</th><td>" + contentRW  + "</td></tr>";
    content = content + "<tr><th>RT</th><td>" + contentRT  + "</td></tr>";
    content = content + "<tr><th>Detail</th><td>" + contentDetail  + "</td></tr>";
    content = content + "<tr><th>Reports</th><td>" + contentReports  + "</td></tr>";
    content = content + "</table>";

    // Use center to put a fixed marker on map
    var marker = L.marker(center, {
      icon: L.icon({
        iconUrl: markerImgPath,
        iconSize: [24, 28],
        iconAnchor: [12, 28],
        popupAnchor: [0, -25]
      }),
      title: popupContent,
      riseOnHover: true
    }).addTo(map);

    layer.on({
      click: function (e) {
        $("#feature-title").html(featureName);
        $("#feature-info").html(content);
        $("#featureModal").modal("show");
        if (feature.geometry.type === 'Point') {
          highlight.clearLayers().addLayer(L.circleMarker(center, highlightStyle));
        }
      }
    });

    marker.on({
      click: function (e) {
        $("#feature-title").html(featureName);
        $("#feature-info").html(content);
        $("#featureModal").modal("show");
        highlight.clearLayers().addLayer(L.circleMarker(center, highlightStyle));
      }
    });

    layerGroupSearch.push({
      name: featureName,
      location: featureLocation,
      source: layerGroupSearchSource,
      id: L.stamp(layer),
      lat: center.lat,
      lng: center.lng
    });
  }
  // end if (feature.properties)
}
// end drawLayerFeature()

var ABRLayer = L.geoJson(null);
var ABR = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#00AEFF',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/abration.png' %}", ABRSearch, "ABR");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=ABR&format=json", function (data) {
  ABR.addData(data);
});

var CEKLayer = L.geoJson(null);
var CEK = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#F07C00',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/tornado.png' %}", CEKSearch, "CEK");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=CEK&format=json", function (data) {
  CEK.addData(data);
});

var BJRLayer = L.geoJson(null);
var BJR = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#3759BF',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/flood.png' %}", BJRSearch, "BJR");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=BJR&format=json", function (data) {
  BJR.addData(data);
});

var ROBLayer = L.geoJson(null);
var ROB = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#128E4D',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/seaflood.png' %}", ROBSearch, "ROB");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=ROB&format=json", function (data) {
  ROB.addData(data);
});

var GMPLayer = L.geoJson(null);
var GMP = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#B52DAC',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/earthquake.png' %}", GMPSearch, "GMP");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=GMP&format=json", function (data) {
  GMP.addData(data);
});

var KBKLayer = L.geoJson(null);
var KBK = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#BD0404',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/fire.png' %}", KBKSearch, "KBK");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=KBK&format=json", function (data) {
  KBK.addData(data);
});

var SOSLayer = L.geoJson(null);
var SOS = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#000000',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/strike.png' %}", SOSSearch, "SOS");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=SOS&format=json", function (data) {
  SOS.addData(data);
});

var LAILayer = L.geoJson(null);
var LAI = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#FFFF00',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/caution.png' %}", LAISearch, "LAI");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=LAI&format=json", function (data) {
  LAI.addData(data);
});

var LSRLayer = L.geoJson(null);
var LSR = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#F06668',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/avalanche.png' %}", LSRSearch, "LSR");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=LSR&format=json", function (data) {
  LSR.addData(data);
});

var TERLayer = L.geoJson(null);
var TER = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#FFFF00',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/shooting.png' %}", TERSearch, "TER");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=TER&format=json", function (data) {
  TER.addData(data);
});

var TSULayer = L.geoJson(null);
var TSU = L.geoJson(null, {
  style: function (feature) {
    return {
      color: '#28ADAD',
      fill: true,
      opacity: 1,
      clickable: true
    };
  },
  onEachFeature: function (feature, layer) {
    drawLayerFeature(feature, layer, "{% static 'img/markers/tsunami.png' %}", TSUSearch, "TSU");
  },
});
$.getJSON("{% url "reports:event_api" %}?disaster=TSU&format=json", function (data) {
  TSU.addData(data);
});

/* Layer control listeners that allow for a single markerClusters layer */
map.on("overlayadd", function(e) {
  if (e.layer === ABRLayer) {
    markerClusters.addLayer(ABR);
    syncSidebar();
  }

  if (e.layer === CEKLayer) {
    markerClusters.addLayer(CEK);
    syncSidebar();
  }

  if (e.layer === BJRLayer) {
    markerClusters.addLayer(BJR);
    syncSidebar();
  }

  if (e.layer === ROBLayer) {
    markerClusters.addLayer(ROB);
    syncSidebar();
  }

  if (e.layer === GMPLayer) {
    markerClusters.addLayer(GMP);
    syncSidebar();
  }

  if (e.layer === KBKLayer) {
    markerClusters.addLayer(KBK);
    syncSidebar();
  }

  if (e.layer === SOSLayer) {
    markerClusters.addLayer(SOS);
    syncSidebar();
  }

  if (e.layer === LAILayer) {
    markerClusters.addLayer(LAI);
    syncSidebar();
  }

  if (e.layer === LSRLayer) {
    markerClusters.addLayer(LSR);
    syncSidebar();
  }

  if (e.layer === TERLayer) {
    markerClusters.addLayer(TER);
    syncSidebar();
  }

  if (e.layer === TSULayer) {
    markerClusters.addLayer(TSU);
    syncSidebar();
  }
});
// end overlayadd

map.on("overlayremove", function(e) {
  if (e.layer === ABRLayer) {
    markerClusters.removeLayer(ABR);
    syncSidebar();
  }

  if (e.layer === CEKLayer) {
    markerClusters.removeLayer(CEK);
    syncSidebar();
  }

  if (e.layer === BJRLayer) {
    markerClusters.removeLayer(BJR);
    syncSidebar();
  }

  if (e.layer === ROBLayer) {
    markerClusters.removeLayer(ROB);
    syncSidebar();
  }

  if (e.layer === GMPLayer) {
    markerClusters.removeLayer(GMP);
    syncSidebar();
  }

  if (e.layer === KBKLayer) {
    markerClusters.removeLayer(KBK);
    syncSidebar();
  }

  if (e.layer === SOSLayer) {
    markerClusters.removeLayer(SOS);
    syncSidebar();
  }

  if (e.layer === LAILayer) {
    markerClusters.removeLayer(LAI);
    syncSidebar();
  }

  if (e.layer === LSRLayer) {
    markerClusters.removeLayer(LSR);
    syncSidebar();
  }

  if (e.layer === TERLayer) {
    markerClusters.removeLayer(TER);
    syncSidebar();
  }

  if (e.layer === TSULayer) {
    markerClusters.removeLayer(TSU);
    syncSidebar();
  }
});
// end overlayremove

var groupedOverlays = {
  "Affected Areas": {
    "<img src='{% static "img/markers/abration.png" %}' width='24' height='28'>&nbsp;Abrasi": ABRLayer,
    "<img src='{% static "img/markers/tornado.png" %}' width='24' height='28'>&nbsp;Angin Kencang": CEKLayer,
    "<img src='{% static "img/markers/flood.png" %}' width='24' height='28'>&nbsp;Banjir": BJRLayer,
    "<img src='{% static "img/markers/seaflood.png" %}' width='24' height='28'>&nbsp;Banjir Rob": ROBLayer,
    "<img src='{% static "img/markers/earthquake.png" %}' width='24' height='28'>&nbsp;Gempa Bumi": GMPLayer,
    "<img src='{% static "img/markers/fire.png" %}' width='24' height='28'>&nbsp;Kebakaran": KBKLayer,
    "<img src='{% static "img/markers/strike.png" %}' width='24' height='28'>&nbsp;Konflik Sosial": SOSLayer,
    "<img src='{% static "img/markers/caution.png" %}' width='24' height='28'>&nbsp;Lain-lain": LAILayer,
    "<img src='{% static "img/markers/avalanche.png" %}' width='24' height='28'>&nbsp;Longsor": LSRLayer,
    "<img src='{% static "img/markers/shooting.png" %}' width='24' height='28'>&nbsp;Terorisme": TERLayer,
    "<img src='{% static "img/markers/tsunami.png" %}' width='24' height='28'>&nbsp;Tsunami": TSULayer,
  },
};

var layerControl = L.control.groupedLayers(baseLayers, groupedOverlays, {
  collapsed: isCollapsed
}).addTo(map);

/* Typeahead search functionality */
$(document).one("ajaxStop", function () {
  $("#loading").hide();
  sizeLayerControl();

  //map.fitBounds(BJR.getBounds());

  featureList = new List("features", {valueNames: ["feature-name"]});
  featureList.sort("feature-name", {order:"asc"});

  var ABRBH = new Bloodhound({
    name: "ABR",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: ABRSearch,
    limit: 10
  });

  var CEKBH = new Bloodhound({
    name: "CEK",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: CEKSearch,
    limit: 10
  });

  var BJRBH = new Bloodhound({
    name: "BJR",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: BJRSearch,
    limit: 10
  });

  var ROBBH = new Bloodhound({
    name: "ROB",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: ROBSearch,
    limit: 10
  });

  var GMPBH = new Bloodhound({
    name: "GMP",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: GMPSearch,
    limit: 10
  });

  var KBKBH = new Bloodhound({
    name: "KBK",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: KBKSearch,
    limit: 10
  });

  var SOSBH = new Bloodhound({
    name: "SOS",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: SOSSearch,
    limit: 10
  });

  var LAIBH = new Bloodhound({
    name: "LAI",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: LAISearch,
    limit: 10
  });

  var LSRBH = new Bloodhound({
    name: "LSR",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: LSRSearch,
    limit: 10
  });

  var TERBH = new Bloodhound({
    name: "TER",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: TERSearch,
    limit: 10
  });

  var TSUBH = new Bloodhound({
    name: "TSU",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: TSUSearch,
    limit: 10
  });

  var geonamesBH = new Bloodhound({
    name: "GeoNames",
    datumTokenizer: function (d) {
      return Bloodhound.tokenizers.whitespace(d.name);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    remote: {
      url: "http://api.geonames.org/searchJSON?username=bootleaf&featureClass=P&maxRows=5&countryCode=US&name_startsWith=%QUERY",
      filter: function (data) {
        return $.map(data.geonames, function (result) {
          return {
            name: result.name + ", " + result.adminCode1,
            lat: result.lat,
            lng: result.lng,
            source: "GeoNames"
          };
        });
      },
      ajax: {
        beforeSend: function (jqXhr, settings) {
          settings.url += "&east=" + map.getBounds().getEast() + "&west=" + map.getBounds().getWest() + "&north=" + map.getBounds().getNorth() + "&south=" + map.getBounds().getSouth();
          $("#searchicon").removeClass("fa-search").addClass("fa-refresh fa-spin");
        },
        complete: function (jqXHR, status) {
          $('#searchicon').removeClass("fa-refresh fa-spin").addClass("fa-search");
        }
      }
    },
    limit: 10
  });

  ABRBH.initialize();
  CEKBH.initialize();
  BJRBH.initialize();
  ROBBH.initialize();
  GMPBH.initialize();
  KBKBH.initialize();
  SOSBH.initialize();
  LAIBH.initialize();
  LSRBH.initialize();
  TERBH.initialize();
  TSUBH.initialize();
  geonamesBH.initialize();

  /* instantiate the typeahead UI */
  $("#searchbox").typeahead(
    {
      minLength: 3,
      highlight: true,
      hint: false
    },
    {
      name: "ABR",
      displayKey: "name",
      source: ABRBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/abration.png" %}' width='24' height='28'>&nbsp;Abrasi</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "CEK",
      displayKey: "name",
      source: CEKBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/tornado.png" %}' width='25' height='25'>&nbsp;Angin Kencang</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "BJR",
      displayKey: "name",
      source: BJRBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/flood.png" %}' width='24' height='28'>&nbsp;Banjir</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "ROB",
      displayKey: "name",
      source: ROBBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/seaflood.png" %}' width='24' height='28'>&nbsp;Banjir Rob</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "GMP",
      displayKey: "name",
      source: GMPBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/earthquake.png" %}' width='24' height='28'>&nbsp;Gempa Bumi</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "KBK",
      displayKey: "name",
      source: KBKBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/fire.png" %}' width='24' height='28'>&nbsp;Kebakaran</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "SOS",
      displayKey: "name",
      source: SOSBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/strike.png" %}' width='24' height='28'>&nbsp;Konflik Sosial</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "LAI",
      displayKey: "name",
      source: LAIBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/caution.png" %}' width='24' height='28'>&nbsp;Lain-lain</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "LSR",
      displayKey: "name",
      source: LSRBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/avalanche.png" %}' width='24' height='28'>&nbsp;Longsor</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "TER",
      displayKey: "name",
      source: TERBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/shooting.png" %}' width='24' height='28'>&nbsp;Terorisme</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
    {
      name: "TSU",
      displayKey: "name",
      source: TSUBH.ttAdapter(),
      templates: {
        header: "<h4 class='typeahead-header'><img src='{% static "img/markers/tsunami.png" %}' width='24' height='28'>&nbsp;Tsunami</h4>",
        suggestion: function (data) {
          return data.name + '<br><small>' + data.location + '</small>';
        }
      }
    },
  {
    name: "GeoNames",
    displayKey: "name",
    source: geonamesBH.ttAdapter(),
    templates: {
      header: "<h4 class='typeahead-header'><img src='{% static "bootleaf_example/assets/img/globe.png" %}' width='25' height='25'>&nbsp;GeoNames</h4>"
    }
  }).on("typeahead:selected", function (obj, datum) {
    if (datum.source === "ABR") {
      if (!map.hasLayer(ABRLayer)) {
        map.addLayer(ABRLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "CEK") {
      if (!map.hasLayer(CEKLayer)) {
        map.addLayer(CEKLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "BJR") {
      if (!map.hasLayer(BJRLayer)) {
        map.addLayer(BJRLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "ROB") {
      if (!map.hasLayer(ROBLayer)) {
        map.addLayer(ROBLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "GMP") {
      if (!map.hasLayer(GMPLayer)) {
        map.addLayer(GMPLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "KBK") {
      if (!map.hasLayer(KBKLayer)) {
        map.addLayer(KBKLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "SOS") {
      if (!map.hasLayer(SOSLayer)) {
        map.addLayer(SOSLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "LAI") {
      if (!map.hasLayer(LAILayer)) {
        map.addLayer(LAILayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "LSR") {
      if (!map.hasLayer(LSRLayer)) {
        map.addLayer(LSRLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "TER") {
      if (!map.hasLayer(TERLayer)) {
        map.addLayer(TERLayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "TSU") {
      if (!map.hasLayer(TSULayer)) {
        map.addLayer(TSULayer);
      }
      map.setView([datum.lat, datum.lng], 17);
      if (map._layers[datum.id]) {
        map._layers[datum.id].fire("click");
      }
    }
    if (datum.source === "GeoNames") {
      map.setView([datum.lat, datum.lng], 14);
    }
    if ($(".navbar-collapse").height() > 50) {
      $(".navbar-collapse").collapse("hide");
    }
  }).on("typeahead:opened", function () {
    $(".navbar-collapse.in").css("max-height", $(document).height() - $(".navbar-header").height());
    $(".navbar-collapse.in").css("height", $(document).height() - $(".navbar-header").height());
  }).on("typeahead:closed", function () {
    $(".navbar-collapse.in").css("max-height", "");
    $(".navbar-collapse.in").css("height", "");
  });
  $(".twitter-typeahead").css("position", "static");
  $(".twitter-typeahead").css("display", "block");
});
// end ajaxStop

// Leaflet patch to make layer control scrollable on touch browsers
var container = $(".leaflet-control-layers")[0];
if (!L.Browser.touch) {
  L.DomEvent
  .disableClickPropagation(container)
  .disableScrollPropagation(container);
} else {
  L.DomEvent.disableClickPropagation(container);
}
{% endblock %}
