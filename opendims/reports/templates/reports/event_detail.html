{% extends "reports/event_list.html" %}

{% load i18n leaflet_tags verbose_names %}

{% block title %}{{ block.super }} - {{ event }}{% endblock %}

{% block extra_css %}
{% leaflet_css %}
{% endblock %}

{% block crumbs %}
{{ block.super }}
<h6 class="page-active">{{ event }}</h6>
{% endblock %}

{% block page_content_upper %}
<div class="widget-main pull-up">
    {% leaflet_map "leaflet_map" callback="window.leaflet_map_init" %}
</div>
{% endblock %}

{% block page_content %}
<h3 class="page-header heading">{{ event }}</h3>

<table class="table table-striped table-bordered">
    <tbody>
        <tr>
            <th class="col-md-2">{% get_verbose_field_name event 'created' %}</th>
            <td>{{ event.created }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'updated' %}</th>
            <td>{{ event.updated }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'status' %}</th>
            <td>{{ event.status }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'disaster' %}</th>
            <td>{{ event.disaster.note }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'height' %}</th>
            <td>{{ event.height }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'magnitude' %}</th>
            <td>{{ event.magnitude }}</td>
        </tr>

        {% if event.province %}
        <tr>
            <th>{% get_verbose_field_name event 'province' %}</th>
            <td><a href="{{ event.province.get_absolute_url }}">{{ event.province }}</a></td>
        </tr>
        {% endif %}

        {% if event.city %}
        <tr>
            <th>{% get_verbose_field_name event 'city' %}</th>
            <td><a href="{{ event.city.get_absolute_url }}">{{ event.city }}</a></td>
        </tr>
        {% endif %}

        {% if event.subdistrict %}
        <tr>
            <th>{% get_verbose_field_name event 'subdistrict' %}</th>
            <td><a href="{{ event.subdistrict.get_absolute_url }}">{{ event.subdistrict }}</a></td>
        </tr>
        {% endif %}

        {% if event.village %}
        <tr>
            <th>{% get_verbose_field_name event 'village' %}</th>
            <td><a href="{{ event.village.get_absolute_url }}">{{ event.village }}</a></td>
        </tr>
        {% endif %}

        {% if event.rw %}
        <tr>
            <th>{% get_verbose_field_name event 'rw' %}</th>
            <td><a href="{{ event.rw.get_absolute_url }}">{{ event.rw }}</a></td>
        </tr>
        {% endif %}

        {% if event.rt %}
        <tr>
            <th>{% get_verbose_field_name event 'rt' %}</th>
            <td><a href="{{ event.rt.get_absolute_url }}">{{ event.rt }}</a></td>
        </tr>
        {% endif %}

        <tr>
            <th>{% get_verbose_field_name event 'note' %}</th>
            <td>{{ event.note }}</td>
        </tr>
    </tbody>
</table>

<h3>{% trans "Reports" %}</h3>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            {% for report in reports|slice:'1' %}
            <th class="col-md-2">{% get_verbose_field_name report 'event' %}</th>
            <th class="col-md-2">{% get_verbose_field_name report 'created' %}</th>
            <th class="col-md-2">{% get_verbose_field_name report 'updated' %}</th>
            <th class="col-md-1">{% get_verbose_field_name report 'source' %}</th>
            <th class="col-md-1">{% get_verbose_field_name report 'status' %}</th>
            <th>{% get_verbose_field_name report 'note' %}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for report in reports %}
        <tr>
            <td><a href="{{ report.get_absolute_url }}">{{ report.event }}</a></td>
            <td>{{ report.created }}</td>
            <td>{{ report.updated }}</td>
            <td>{{ report.source.note }}</td>
            <td>{{ report.status }}</td>
            <td>{{ report.note }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">{% trans "No reports found for this event." %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>{% trans "Evacuation Points" %}</h3>

<div id="widget-main pull-up">
    {% leaflet_map "leaflet_map_evacuation" callback="window.leaflet_map_evacuation_init" %}
</div>

<h3>{% trans "Event Impacts" %}</h3>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            {% for eventimpact in eventimpacts|slice:'1' %}
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'event' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'village' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'rw' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'rt' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'rt_text' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'evac_total' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'affected_total' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimpact 'affected_death' %}</th>
            <th class="col-md-1">{% get_verbose_field_name eventimpact 'affected_injury' %}</th>
            <th class="col-md-1">{% get_verbose_field_name eventimpact 'loss_total' %}</th>
            <th>{% get_verbose_field_name eventimpact 'note' %}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for eventimpact in eventimpacts %}
        <tr>
            <td><a href="{{ event.get_absolute_url }}">{{ eventimpact.event }}</a></td>
            <td><a href="{{ event.village.get_absolute_url }}">{{ eventimpact.village }}</a></td>
            <td><a href="{{ event.rw.get_absolute_url }}">{{ eventimpact.rw }}</a></td>
            <td>{{ eventimpact.rt }}</a></td>
            <td>{{ eventimpact.rt_text }}</td>
            <td>{{ eventimpact.evac_total }}</td>
            <td>{{ eventimpact.affected_total }}</td>
            <td>{{ eventimpact.affected_death }}</td>
            <td>{{ eventimpact.affected_injury }}</td>
            <td>{{ eventimpact.loss_total }}</td>
            <td>{{ eventimpact.note }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">{% trans "No Event impacts found for this event." %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>{% trans "Event images" %}</h3>

<table class="table table-striped table-bordered">
    <thead>

        <tr>
            {% for eventimage in eventimages|slice:'1' %}
            <th class="col-md-2">{% get_verbose_field_name eventimage 'event' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimage 'image' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimage 'order' %}</th>
            <th class="col-md-2">{% get_verbose_field_name eventimage 'published' %}</th>
            {% endfor %}
        </tr>

    </thead>
    <tbody>
        {% for eventimage in eventimages %}
        <tr>
            <td><a href="{{ event.get_absolute_url }}">{{ eventimage.event }}</a></td>
            <td><img src="{{ eventimage.image.url }}"></td>
            <td>{{ eventimage.order }}</td>
            <td>{{ eventimage.published }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">{% trans "No Event images found for this event." %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{% block extra_js %}
{% leaflet_js %}
<script type="text/javascript">
/**
 * Show the polygon of the affected area in the lowest defined
 * administrative area and display a popup of the event details.
 */
function leaflet_map_init(map, options) {

    {% if event.province %}
    var provinceLayer = L.geoJson({{ event.province.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.city %}
    if (typeof provinceLayer !== 'undefined') {
        map.removeLayer(provinceLayer);
    }
    var cityLayer = L.geoJson({{ event.city.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.subdistrict %}
    if (typeof cityLayer !== 'undefined') {
        map.removeLayer(cityLayer);
    }
    var subdistrictLayer = L.geoJson({{ event.subdistrict.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.village %}
    if (typeof subdistrictLayer !== 'undefined') {
        map.removeLayer(subdistrictLayer);
    }
    var villageLayer = L.geoJson({{ event.village.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.rw %}
    if (typeof villageLayer !== 'undefined') {
        map.removeLayer(villageLayer);
    }
    var rwLayer = L.geoJson({{ event.rw.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.rt %}
    if (typeof rwLayer !== 'undefined') {
        map.removeLayer(rwLayer);
    }
    var rtLayer = L.geoJson({{ event.rt.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.point %}
    var pointLayer = L.geoJson({{ event.point.geojson|safe }}).addTo(map);
    {% endif %}

    var popupContent = `
    <table class="table table-striped table-bordered">
        <tbody>
            <tr>
                <th class="col-md-2">{% get_verbose_field_name event 'created' %}</th>
                <td>{{ event.created }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'status' %}</th>
                <td>{{ event.status }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'disaster' %}</th>
                <td>{{ event.disaster.note }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'height' %}</th>
                <td>{{ event.height }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'magnitude' %}</th>
                <td>{{ event.magnitude }}</td>
            </tr>

            {% if event.province %}
            <tr>
                <th>{% get_verbose_field_name event 'province' %}</th>
                <td><a href="{{ event.province.get_absolute_url }}">{{ event.province }}</a></td>
            </tr>
            {% endif %}

            {% if event.city %}
            <tr>
                <th>{% get_verbose_field_name event 'city' %}</th>
                <td><a href="{{ event.city.get_absolute_url }}">{{ event.city }}</a></td>
            </tr>
            {% endif %}

            {% if event.subdistrict %}
            <tr>
                <th>{% get_verbose_field_name event 'subdistrict' %}</th>
                <td><a href="{{ event.subdistrict.get_absolute_url }}">{{ event.subdistrict }}</a></td>
            </tr>
            {% endif %}

            {% if event.village %}
            <tr>
                <th>{% get_verbose_field_name event 'village' %}</th>
                <td><a href="{{ event.village.get_absolute_url }}">{{ event.village }}</a></td>
            </tr>
            {% endif %}

            {% if event.rw %}
            <tr>
                <th>{% get_verbose_field_name event 'rw' %}</th>
                <td><a href="{{ event.rw.get_absolute_url }}">{{ event.rw }}</a></td>
            </tr>
            {% endif %}

            {% if event.rt %}
            <tr>
                <th>{% get_verbose_field_name event 'rt' %}</th>
                <td><a href="{{ event.rt.get_absolute_url }}">{{ event.rt }}</a></td>
            </tr>

            <tr>
                <th>{% get_verbose_field_name event 'note' %}</th>
                <td>{{ event.note }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    `;

    var popupLayer;

    if (typeof pointLayer !== 'undefined') {
        var pointBounds = pointLayer.getBounds();
        var pointCenter = pointBounds.getCenter();
        map.setZoom(16);
        map.panTo(pointCenter);
        popupLayer = pointLayer;
    } else if (typeof rtLayer !== 'undefined') {
        map.fitBounds(rtLayer);
        popupLayer = rtLayer;
    } else if (typeof rwLayer !== 'undefined') {
        map.fitBounds(rwLayer);
        popupLayer = rwLayer;
    } else if (typeof villageLayer !== 'undefined') {
        map.fitBounds(villageLayer);
        popupLayer = villageLayer;
    } else if (typeof subdistrictLayer !== 'undefined') {
        map.fitBounds(subdistrictLayer);
        popupLayer = subdistrictLayer;
    } else if (typeof cityLayer !== 'undefined') {
        map.fitBounds(cityLayer);
        popupLayer = cityLayer;
    } else if (typeof provinceLayer !== 'undefined') {
        map.fitBounds(provinceLayer);
        popupLayer = provinceLayer;
    }

    popupLayer.bindPopup(popupContent);
}

function leaflet_map_evacuation_init(map, options) {

    {% if event.province %}
    var provinceLayer = L.geoJson({{ event.province.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.city %}
    if (typeof provinceLayer !== 'undefined') {
        map.removeLayer(provinceLayer);
    }
    var cityLayer = L.geoJson({{ event.city.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.subdistrict %}
    if (typeof cityLayer !== 'undefined') {
        map.removeLayer(cityLayer);
    }
    var subdistrictLayer = L.geoJson({{ event.subdistrict.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.village %}
    if (typeof subdistrictLayer !== 'undefined') {
        map.removeLayer(subdistrictLayer);
    }
    var villageLayer = L.geoJson({{ event.village.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.rw %}
    if (typeof villageLayer !== 'undefined') {
        map.removeLayer(villageLayer);
    }
    var rwLayer = L.geoJson({{ event.rw.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.rt %}
    if (typeof rwLayer !== 'undefined') {
        map.removeLayer(rwLayer);
    }
    var rtLayer = L.geoJson({{ event.rt.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    var popupContent = `
    <table class="table table-striped table-bordered">
        <tbody>
        {% for eventimpact in eventimpacts %}
            <tr>
                <th class="col-md-2">{% get_verbose_field_name eventimpact 'evac_total' %}</th>
                <td>{{ eventimpact.evac_total }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name eventimpact 'affected_death' %}</th>
                <td>{{ eventimpact.affected_death }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name eventimpact 'affected_total' %}</th>
                <td>{{ eventimpact.affected_death }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name eventimpact 'affected_injury' %}</th>
                <td>{{ eventimpact.affected_injury }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name eventimpact 'loss_total' %}</th>
                <td>{{ eventimpact.loss_total }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name eventimpact 'note' %}</th>
                <td>{{ eventimpact.note }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    `;

    var popupLayer;

    /* looping through event impact to get evac_point */
    {% for eventimpact in eventimpacts %}

    var evacpointLayer = L.geoJson({{ eventimpact.evac_point.geojson|safe }}).addTo(map);
        popupLayer = evacpointLayer
        popupLayer.bindPopup(popupContent);

    {% endfor %}

}
</script>
{% endblock %}
