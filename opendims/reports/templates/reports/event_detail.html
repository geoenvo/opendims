{% extends "opendims/base.html" %}

{% load i18n leaflet_tags verbose_names %}

{% block opendims_title %} - {{ event }}{% endblock %}

{% block extra_css %}

{% leaflet_css %}

<style>
.leaflet-container {
    height: 400px;
}
</style>

{% endblock %}

{% block opendims_content %}

<div class="page-header">
    <h2>{{ event }}</h2>
</div>

<table class="table table-striped table-bordered">
    <tbody>
        <tr>
            <th>{% get_verbose_field_name event 'created' %}</th>
            <td>{{ event.created }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'disaster' %}</th>
            <td>{{ event.disaster }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'height' %}</th>
            <td>{{ event.height }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'magnitude' %}</th>
            <td>{{ event.magnitude }}</td>
        </tr>
        <tr>
            <th>{% get_verbose_field_name event 'note' %}</th>
            <td>{{ event.note }}</td>
        </tr>
        {% if event.province %}
        <tr>
            <th>{% get_verbose_field_name event 'province' %}</th>
            <td><a href="{% url 'geolevels:province_detail' event.province.pk %}">{{ event.province }}</a></td>
        </tr>
        {% endif %}
        {% if event.city %}
        <tr>
            <th>{% get_verbose_field_name event 'city' %}</th>
            <td><a href="{% url 'geolevels:city_detail' event.city.pk %}">{{ event.city }}</a></td>
        </tr>
        {% endif %}
        {% if event.subdistrict %}
        <tr>
            <th>{% get_verbose_field_name event 'subdistrict' %}</th>
            <td><a href="{% url 'geolevels:subdistrict_detail' event.subdistrict.pk %}">{{ event.subdistrict }}</a></td>
        </tr>
        {% endif %}
        {% if event.village %}
        <tr>
            <th>{% get_verbose_field_name event 'village' %}</th>
            <td><a href="{% url 'geolevels:village_detail' event.village.pk %}">{{ event.village }}</a></td>
        </tr>
        {% endif %}
        {% if event.rw %}
        <tr>
            <th>{% get_verbose_field_name event 'rw' %}</th>
            <td><a href="{% url 'geolevels:rw_detail' event.rw.pk %}">{{ event.rw }}</a></td>
        </tr>
        {% endif %}
        {% if event.rt %}
        <tr>
            <th>{% get_verbose_field_name event 'rt' %}</th>
            <td><a href="{% url 'geolevels:rt_detail' event.rt.pk %}">{{ event.rt }}</a></td>
        </tr>
        {% endif %}
    </tbody>
</table>

<h3>{% trans 'Affected area' %}</h3>

{% leaflet_map "event_map" callback="window.event_map_init" %}

<h3>{% trans 'Reports' %}</h3>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            {% for report in reports|slice:'1' %}
            <th>{% get_verbose_field_name report 'created' %}</th>
            <th>{% get_verbose_field_name report 'updated' %}</th>
            <th>{% get_verbose_field_name report 'event' %}</th>
            <th>{% get_verbose_field_name report 'source' %}</th>
            <th>{% get_verbose_field_name report 'status' %}</th>
            <th>{% get_verbose_field_name report 'note' %}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for report in reports %}
        <tr>
            <td><a href="{% url 'reports:report_detail' report.pk  %}">{{ report.created }}</a></td>
            <td>{{ report.updated }}</td>
            <td>{{ report.event }}</td>
            <td>{{ report.source }}</td>
            <td>{{ report.status }}</td>
            <td>{{ report.note }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="text-align: center;">{% trans 'No reports found for this event.' %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{% block extra_js %}

{% leaflet_js %}

<script type="text/javascript">
/**
 * Show the polygon of the affected area in the lowest defined
 * administrative area and display a popup of the event details.
 */
function event_map_init(map, options) {
    {% if event.province %}
    var provinceLayer = L.geoJson({{ event.province.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.city %}
    if (typeof provinceLayer !== 'undefined') {
        map.removeLayer(provinceLayer);
    }
    var cityLayer = L.geoJson({{ event.city.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.subdistrict %}
    if (typeof cityLayer !== 'undefined') {
        map.removeLayer(cityLayer);
    }
    var subdistrictLayer = L.geoJson({{ event.subdistrict.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.village %}
    if (typeof subdistrictLayer !== 'undefined') {
        map.removeLayer(subdistrictLayer);
    }
    var villageLayer = L.geoJson({{ event.village.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.rw %}
    if (typeof villageLayer !== 'undefined') {
        map.removeLayer(villageLayer);
    }
    var rwLayer = L.geoJson({{ event.rw.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.rt %}
    if (typeof rwLayer !== 'undefined') {
        map.removeLayer(rwLayer);
    }
    var rtLayer = L.geoJson({{ event.rt.polygon.geojson|safe }}).addTo(map);
    {% endif %}

    {% if event.point %}
    var pointLayer = L.geoJson({{ event.point.geojson|safe }}).addTo(map);
    {% endif %}
    
    var popupContent = `
    <table class="table table-striped table-bordered">
        <tbody>
            <tr>
                <th>{% get_verbose_field_name event 'created' %}</th>
                <td>{{ event.created }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'disaster' %}</th>
                <td>{{ event.disaster }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'height' %}</th>
                <td>{{ event.height }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'magnitude' %}</th>
                <td>{{ event.magnitude }}</td>
            </tr>
            <tr>
                <th>{% get_verbose_field_name event 'note' %}</th>
                <td>{{ event.note }}</td>
            </tr>
            {% if event.province %}
            <tr>
                <th>{% get_verbose_field_name event 'province' %}</th>
                <td><a href="{% url 'geolevels:province_detail' event.province.pk %}">{{ event.province }}</a></td>
            </tr>
            {% endif %}
            {% if event.city %}
            <tr>
                <th>{% get_verbose_field_name event 'city' %}</th>
                <td><a href="{% url 'geolevels:city_detail' event.city.pk %}">{{ event.city }}</a></td>
            </tr>
            {% endif %}
            {% if event.subdistrict %}
            <tr>
                <th>{% get_verbose_field_name event 'subdistrict' %}</th>
                <td><a href="{% url 'geolevels:subdistrict_detail' event.subdistrict.pk %}">{{ event.subdistrict }}</a></td>
            </tr>
            {% endif %}
            {% if event.village %}
            <tr>
                <th>{% get_verbose_field_name event 'village' %}</th>
                <td><a href="{% url 'geolevels:village_detail' event.village.pk %}">{{ event.village }}</a></td>
            </tr>
            {% endif %}
            {% if event.rw %}
            <tr>
                <th>{% get_verbose_field_name event 'rw' %}</th>
                <td><a href="{% url 'geolevels:rw_detail' event.rw.pk %}">{{ event.rw }}</a></td>
            </tr>
            {% endif %}
            {% if event.rt %}
            <tr>
                <th>{% get_verbose_field_name event 'rt' %}</th>
                <td><a href="{% url 'geolevels:rt_detail' event.rt.pk %}">{{ event.rt }}</a></td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    `;
    
    var popupLayer;
    
    if (typeof pointLayer !== 'undefined') {
        var pointBounds = pointLayer.getBounds();    
        var pointCenter = pointBounds.getCenter();
        map.setZoom(16);
        map.panTo(pointCenter);
        popupLayer = pointLayer;
    } else if (typeof rtLayer !== 'undefined') {
        map.fitBounds(rtLayer);
        popupLayer = rtLayer;
    } else if (typeof rwLayer !== 'undefined') {
        map.fitBounds(rwLayer);
        popupLayer = rwLayer;
    } else if (typeof villageLayer !== 'undefined') {
        map.fitBounds(villageLayer);
        popupLayer = villageLayer;
    } else if (typeof subdistrictLayer !== 'undefined') {
        map.fitBounds(subdistrictLayer);
        popupLayer = subdistrictLayer;
    } else if (typeof cityLayer !== 'undefined') {
        map.fitBounds(cityLayer);
        popupLayer = cityLayer;
    } else if (typeof provinceLayer !== 'undefined') {
        map.fitBounds(provinceLayer);
        popupLayer = provinceLayer;
    }
    
    popupLayer.bindPopup(popupContent).openPopup();
}
</script>

{% endblock %}